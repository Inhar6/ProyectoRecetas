name: Integraci√≥n Continua (Microservicios Recetas)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # Permite ejecutar el workflow manualmente desde la interfaz de GitHub
  workflow_dispatch:

jobs:
  build_and_test:
    # Ejecuta en un entorno Ubuntu Linux reciente
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout C√≥digo üì¶
        uses: actions/checkout@v4

      # --- Configuraci√≥n de Docker y dependencias ---
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Build & Run Docker Compose üê≥
        # El flag --build asegura que se construyan las im√°genes m√°s recientes
        run: docker compose up --build -d

      # --- Verificaci√≥n de Salud y Estabilidad ---
      # **Paso CR√çTICO:** Espera a que el servicio Python est√© listo.
      - name: Wait for Python Service Health Check ‚è≥
        # La pausa es necesaria para superar la fase de reintento de conexi√≥n a PostgreSQL
        run: |
          echo "Esperando 25 segundos para que los contenedores se estabilicen (Python DB retries)..."
          sleep 25
          # Verificaci√≥n avanzada: B√∫squeda de logs de √©xito del cat√°logo
          if docker compose logs ms-catalogo-py | grep "Tablas de PostgreSQL verificadas/creadas con √©xito."; then
            echo "El Microservicio de Cat√°logo est√° conectado a PostgreSQL."
          else
            echo "ERROR: El Microservicio de Cat√°logo fall√≥ al conectar a PostgreSQL."
            exit 1 # Falla el job si no encuentra el mensaje de √©xito
          fi
          
      # --- Prueba de Integraci√≥n (End-to-End B√°sico) ---
      - name: Run Gateway Integration Test ‚úÖ
        # Prueba la comunicaci√≥n entre el Gateway (8080) y el Cat√°logo (5000)
        # curl --fail fuerza a que el job falle si recibe un c√≥digo de error (4xx/5xx)
        run: |
          echo "Probando el endpoint principal del Gateway..."
          curl --fail http://localhost:8080/api/v1/recetas

      # --- Limpieza ---
      - name: Cleanup Containers
        if: always() # Ejecuta siempre, incluso si los pasos anteriores fallan
        run: docker compose down -v